<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elasticsearch &middot; Big Bag Blog</title>

    <meta name="description" content="Need a place to hide">

    <meta name="generator" content="Hugo 0.14" />
    <meta name="twitter:card" content="summary">
    
    <meta name="twitter:title" content="Elasticsearch &middot; Big Bag Blog">
    <meta name="twitter:description" content="Need a place to hide">

    <meta property="og:type" content="article">
    <meta property="og:title" content="Elasticsearch &middot; Big Bag Blog">
    <meta property="og:description" content="Need a place to hide">

    <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700|Oxygen:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/pure-min.css">
    <!--[if lte IE 8]>
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-old-ie-min.css">
    <![endif]-->
    <!--[if gt IE 8]><!-->
        <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/pure/0.6.0/grids-responsive-min.css">
    <!--<![endif]-->

    <link rel="stylesheet" href="http://blog.pedrazas.me/css/all.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">

    <link rel="alternate" type="application/rss+xml" title="Big Bag Blog" href="http://blog.pedrazas.me/index.xml" />
</head>
<body>


<div id="layout" class="pure-g">
    <div class="sidebar pure-u-1 pure-u-md-1-4">
    <div class="header">
        <hgroup>
            <h1 class="brand-title"><a href="http://blog.pedrazas.me">Big Bag Blog</a></h1>
            <h2 class="brand-tagline"> Need a place to hide </h2>
        </hgroup>

        <nav class="nav">
            <ul class="nav-list">
                
                <li class="nav-item">
                    <a class="pure-button" href="https://twitter.com/ipedrazas"><i class="fa fa-twitter"></i> Twitter</a>
                </li>
                
                
                <li class="nav-item">
                    <a class="pure-button" href="https://github.com/ipedrazas "><i class="fa fa-github-alt"></i> github</a>
                </li>
                
                <li class="nav-item">
                    <a class="pure-button" href="http://blog.pedrazas.me/index.xml"><i class="fa fa-rss"></i> rss</a>
                </li>
            </ul>
        </nav>
    </div>
</div>


    <div class="content pure-u-1 pure-u-md-3-4">
        <div>
            
            <div class="posts">
                
                <h1 class="content-subhead">07 Sep 2014</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.pedrazas.me/2014/09/07/from-my-browsing-history/" class="post-title">Analytics From my Browsing History</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">ipedrazas</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-analytics" href="http://blog.pedrazas.me/categories/analytics">analytics</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>One of the problems I had while writing dotMarks was the fact that I could not get enough URLs for my testing. I did ask friends and family to send me over their exported list of bookmarks or the bookmarks from pocket&#8230; but <a href="https://www.youtube.com/watch?v=Pj-qBUWOYfE">I needed more data</a>, so, I look somewhere else: My browsing history.</p>

<p>Of course I couldn&#8217;t just get those links &#8220;<strong><em>and carry on</em></strong>&#8220;. I had to look at them, poke them and write an extension that allows me to analyse them.</p>

<p>Because, the idea was&#8230; what kind of high level information can Google (or anyone else) know from just looking at my browing history? and the result was as scary as you might imagine.</p>

<p>Bear in mind that Google knows much more than just my history&#8230; but that&#8217;s for another post. Let&#8217;s focus!</p>

<p>This extension basically gathers all your browing history (100 days max), sends it to dotmarks where some data-crunching happens and&#8230; then you see the results.</p>

<p>For example, it checks at what time you visit a link and creates this pretty graph:</p>

<p><a href="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111057.png"><img class="aligncenter size-medium wp-image-330" src="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111057-300x167.png" alt="Screenshot from 2014-09-07 11:10:57" width="300" height="167" /></a></p>

<p>Which highlights something that everybody who knows me is aware of: I do not sleep much and&#8230; that I work very early in the morning, or very late at night.</p>

<p>I was very curious about finding out my most visited websites&#8230; nothing surprising here:</p>

<p><a href="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111147.png"><img class="aligncenter size-medium wp-image-328" src="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111147-300x207.png" alt="Screenshot from 2014-09-07 11:11:47" width="300" height="207" /></a></p>

<p>That I do not procastinate as much as I thought is quiet clear (twitter reloads itself a lot, that&#8217;s why it ranks so high), but mostly I work on my localhost&#8230; and check how my Bitcoins are doing at <a href="http://megamine.com/">Megamine</a>.</p>

<p><a href="http://ivan.pedrazas.me/wp-content/uploads/2014/09/theres-no-place-like-127-0-0-1-localhost-computer-print-poster.jpg"><img class="aligncenter size-medium wp-image-333" src="http://ivan.pedrazas.me/wp-content/uploads/2014/09/theres-no-place-like-127-0-0-1-localhost-computer-print-poster-300x200.jpg" alt="theres-no-place-like-127-0-0-1-localhost-computer-print-poster" width="300" height="200" /></a></p>

<p>Then, I started extracting keywords from my searches&#8230; and things got more interesting:</p>

<p><a href="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111126.png"><img class="aligncenter size-medium wp-image-329" src="http://ivan.pedrazas.me/wp-content/uploads/2014/09/Screenshot-from-2014-09-07-111126-300x209.png" alt="Screenshot from 2014-09-07 11:11:26" width="300" height="209" /></a></p>

<p>Yes, I do search about superheroes a lot&#8230; things of having children addicted to Thor, Spiderman and such troop.</p>

<p>What is really interesting is how high rank generics like java, python or ubuntu. I was a bit puzzled at first, then I realised that those keywords are ways of filtering out unwanted results. No surprise then, I do work with ubuntu, java and python.</p>

<p>Still, top marks for the two technologies I&#8217;ve been working more with: ElasticSearch and Docker. ElasticSearch documentation is quite dry&#8230; Docker, because I&#8217;m trying to do a bit too much I guess.</p>

<p><a href="https://dotmarks.net">dotMarks</a> is a self hosted bookmarks service. The idea is that you will run your own dotMarks server. I&#8217;m working hard to make it as easy as possible to run it (thanks to Docker) but if you&#8217;re curious and want to see what your browsing history says about you, <a href="https://github.com/ipedrazas/dotmarks-history">download the extension</a> and give it a go.</p>

<p>What I need is advice  <img src="http://ivan.pedrazas.me/wp-includes/images/smilies/icon_smile.gif" alt=":)" class="wp-smiley" />If you run the extension and think of something else I can extract I&#8217;m all ears.</p>

<p>Currently I&#8217;m working on a simple amazon parser, but it&#8217;s still very early&#8230; anyway, if you want to give it a go, by all means try it out and if you can share your feedback <a href="https://twitter.com/ipedrazas">with me</a>, I would really appreciate it.</p>

<p>&nbsp;</p>

<p><strong>Disclaimer</strong>: <a href="https://dotmarks.net">dotMarks</a> and all related to this project is OpenSource. I do have a working version <a href="https://dotmarks.net/app/#/dotmarks">here</a>, but as I said, the idea is that you will run your own service. Still, if you want to add your bookmarks, go ahead, and if you want to be able to find them later, use a tag that you can recognise later.</p>

<p>&nbsp;</p>

                    </div>
                </section>
                
                <h1 class="content-subhead">05 Aug 2014</h1>
                <section class="post">
                    <header class="post-header">

                        <a href="http://blog.pedrazas.me/2014/08/05/fhr-elasticsearch-aggregations/" class="post-title">What’s the Filthiest PostCode in UK? and the Cleanest too!</a>

                        <p class="post-meta">
                            
                                By <strong class="post-author">ipedrazas</strong>
                            
                            
                                under 
                                
                                <a class="post-category post-category-Development" href="http://blog.pedrazas.me/categories/development">Development</a><a class="post-category post-category-Java" href="http://blog.pedrazas.me/categories/java">Java</a>
                            
                        </p>
                    </header>

                    <div class="post-description">
                        <p>There&#8217;s a <a href="https://github.com/ipedrazas/crawlers/tree/master/FHR">GitHub repo</a> associated to this post that <a href="https://github.com/ipedrazas/crawlers/tree/master/FHR">it can be found here</a></p>

<p>Do you know that sticker on the window of most takeaway shops? that sticker displays the Hygiene rating. This post is not about those stickers.</p>

<p><img class="aligncenter size-full wp-image-303" src="http://ivan.pedrazas.me/wp-content/uploads/2014/08/fhrs_5_en-gb.jpg" alt="Hygiene Rating Sticker" width="290" height="148" /></p>

<p>Now, as it happens, restaurants, deli bars and of course, take away shops are checked up regularly to see how clean are they and the collected information ends up in a report, a sticker and&#8230; some dark and remote database.</p>

<p>After doing the ElastiSearch training three weeks ago I was itching to do some aggregations with it. I have done aggregations before using &#8220;<em>Ye Olde</em>&#8221; Map/Reduce approach and I was interested on seeing how it would compare to do agregations with MongoDB.</p>

<p>I found the Food and Higiene dataset and a python script later I had all their data in my hard drive (just under 500MB of XMLs). Since I like diversity, I wrote a Java program to parse those XMLs and add them into my ElasticSearch instance. It really surprised me the amount of time spent on preparing the data before being able to execute the analysis. I know, it shouldn&#8217;t but it does&#8230; every single time it does.</p>

<p>Anyway, I run ElasticSearch in a docker instance that has the Marvel plugin in it. This plugin is perfect for throwing a few quick queries and getting some json back. Of course, me being me, I could not just do some tests and write a blog post&#8230; I had to create <a href="https://github.com/ipedrazas/crawlers/tree/master/FHR">a Github Repo</a> where you can find the source code (just in case you do want to try it by yourself), results (in json files) and some more detailed explanation about how to fetch the data, run the docker container and the different queries I issued.</p>

<p>After indexing almost half a Gigabyte I discovered that the average rating In UK for Food Hygiene is <strong>3.5849</strong> which is not that great, is it? I mean, we are talking about how clean is the place where we eat: &#8220;kind of not clean but not dirty neither&#8221;.</p>

<p>What else did I find? Well, I was interested on my area (NW10) average: <strong>3.23910171730515  </strong>Depressing, I guess it&#8217;s time to move to&#8230; where?</p>

<p>Well, let&#8217;s find out, what&#8217;s the cleanest Post Code? I didn&#8217;t know much about UK PostCodes. Post Code indicates the area (outward) and the building/house (inward). The dataset provides longitude and latitude for every single establishment so you don&#8217;t really need the PostCode to put the stablishment in a map. Anyway, that was not my intention.</p>

<p>So, as it turns, the cleanest Post Code is <a href="https://www.google.co.uk/maps/place/South+Petherton,+Somerset+TA13/@50.8277828,-2.2505537,9z/data=!4m2!3m1!1s0x48726c54bfd88a65:0xc91f5b601623f2d1">SOUTH PETHERTON (TA13)</a>, or if you think that 42 establishments and an average of <strong>4.761904761904762</strong> is not significant enough I can move to <a href="https://www.google.co.uk/maps/place/Taunton,+Somerset/@52.1627957,-1.8741876,7z/data=!4m2!3m1!1s0x486d8a921fb7907f:0x75eb0e344edee9fb">TAUNTON (TA3)</a> with a wooping average of <strong>4.642857142857143</strong></p>

<p>And now that we know where to go, which place we should all avoid? Ladies and Gentlemen, the filthiest area in UK is (shame on you)&#8230;</p>

<p><a href="https://www.google.co.uk/maps/place/Hawick,+Scottish+Borders+TD9/@53.3002712,-2.738034,7z/data=!4m6!1m3!3m2!1s0x487d796662ced111:0x2cc564208e63c086!2sShankend+Holiday+Cottage+Hawick!3m1!1s0x487d605a6cc3a265:0x188c40d9107d6db6">HAWICK, NEWCASTLETON (TD9)</a> with a terrible average of <strong>0.013761467889908258</strong> (yes, that&#8217;s Zero point Zero One).</p>

<pre>{
   "key": "td9",
   "doc_count": 218,
   "avg_height": {
      "value": 0.013761467889908258
   }
},

 {
   "key": "ta13",
   "doc_count": 42,
   "avg_height": {
      "value": 4.761904761904762
   }
},
{
   "key": "ta3",
   "doc_count": 112,
   "avg_height": {
      "value": 4.642857142857143
   }
},
</pre>

<p>But let&#8217;s not stop there&#8230; What is the most common rating? XX</p>

<p>The Food Standars Agency has a web form that let&#8217;s you check the rating of your favourite place.</p>

<p>Let me show you one of the queries I used, just in case you&#8217;re looking at how to do aggregations with ElasticSearch and are struggling with the lack of documentation:</p>

<pre>GET _search
{

   "query" : {
      "match" : { "PostCode" : "PO18*"}
       },
   "aggs" : {
        "Food_hygiene_ratings" : {
           "terms" : {
             "field" : "RatingValue"
           }
        },

        "avg_height" : {
          "avg" : {
            "field" : "RatingValue" }

        }
      }
}
</pre>

<p>This query matches a PostCode (PO18 ) and then it aggregates twice the result using the field RatingValue. The first one will give you the count of the different ratings and the second one will give you the average of the rating.</p>

<p>Conclusion? prepating the data was quiet of a pain, but it always is. Loading the data was blazing fast and the results were pretty quick too. The aggregation of all the PostCodes took a few seconds and the huge amount of data that it returned was impressive.</p>

<p>All in all, a very quick way of getting some json data to feed into the D3 visualisations.</p>

<p><a href="http://en.wikipedia.org/wiki/List_of_postcode_areas_in_the_United_Kingdom">http://en.wikipedia.org/wiki/List_of_postcode_areas_in_the_United_Kingdom</a></p>

<pre>GET _search
{

   "aggs" : {
        "Food_hygiene_ratings" : {
           "terms" : {
             "field" : "areacode",
             "size": 0,
             "order": {
                    "avg_height": "desc"
                }

           },

           "aggs":{
             "postcodes":{
             "terms" : {
               "field" : "RatingValue"
              }
             }
             ,

        "avg_height" : {
          "avg" : {
            "field" : "RatingValue"

          }

        }
           }
        }
      }
}
</pre>

<p>Once we know the area, we want to filter by outward</p>

<p><strong>Worst case TD</strong></p>

<pre>GET _search
{

    "query" : {
      "match" : { "areacode" : "td"}
       },
   "aggs" : {
        "Food_hygiene_ratings" : {
           "terms" : {
             "field" : "outward",
             "size": 0,
             "order": {
                    "avg_height": "desc"
                }

           },

           "aggs":{

              "avg_height" : {
                "avg" : {
                  "field" : "RatingValue"
                }

              }
           }
      }
    }
}

</pre>

<p><strong>Worst case</strong></p>

<pre>"key": "td",
   "doc_count": 1492,
   "postcodes": {
      "buckets": [
         {
            "key": 0,
            "key_as_string": "0",
            "doc_count": 1244
         },
         {
            "key": 5,
            "key_as_string": "5",
            "doc_count": 152
         },
         {
            "key": 4,
            "key_as_string": "4",
            "doc_count": 53
         },
         {
            "key": 3,
            "key_as_string": "3",
            "doc_count": 37
         },
         {
            "key": 1,
            "key_as_string": "1",
            "doc_count": 4
         },
         {
            "key": 2,
            "key_as_string": "2",
            "doc_count": 2
         }
      ]
   },
   "avg_height": {
      "value": 0.7312332439678284
   }
},

</pre>

<p><strong>Best case</strong></p>

<pre>{
   "key": "ta",
   "doc_count": 2823,
   "postcodes": {
      "buckets": [
         {
            "key": 5,
            "key_as_string": "5",
            "doc_count": 1955
         },
         {
            "key": 4,
            "key_as_string": "4",
            "doc_count": 521
         },
         {
            "key": 3,
            "key_as_string": "3",
            "doc_count": 152
         },
         {
            "key": 0,
            "key_as_string": "0",
            "doc_count": 107
         },
         {
            "key": 1,
            "key_as_string": "1",
            "doc_count": 52
         },
         {
            "key": 2,
            "key_as_string": "2",
            "doc_count": 36
         }
      ]
   },
   "avg_height": {
      "value": 4.406305348919589
   }
},
</pre>

                    </div>
                </section>
                
            </div>
            

            <div class="footer">
    <div class="pure-menu pure-menu-horizontal pure-menu-open">
        <ul>
            <li>Powered by <a class="hugo" href="http://hugo.spf13.com/" target="_blank">hugo</a></li>
        </ul>
    </div>
</div>
<script src="http://blog.pedrazas.me/js/all.min.js"></script>
        </div>
    </div>
</div>

<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

ga('create', '', 'auto');
ga('send', 'pageview');

</script>

</body>
</html>
